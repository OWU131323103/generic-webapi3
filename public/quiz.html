<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Quiz Synchronized</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="quiz.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="background-animation"></div>
    
    <div class="container">
        <div id="connectionPanel" class="glass-panel connection-panel">
            <h3><i class="fa-solid fa-link"></i> æ¥ç¶šãƒ¢ãƒ¼ãƒ‰é¸æŠ</h3>
            
            <div class="mode-buttons">
                <button class="btn mode-btn" onclick="setMode('host')">
                    <i class="fa-solid fa-desktop"></i>
                    <span>ãƒ‘ã‚½ã‚³ãƒ³<br><small>(ç”»é¢)</small></span>
                </button>
                <button class="btn mode-btn" onclick="setMode('controller')">
                    <i class="fa-solid fa-mobile-screen"></i>
                    <span>ã‚¹ãƒãƒ›<br><small>(ãƒªãƒ¢ã‚³ãƒ³)</small></span>
                </button>
            </div>
            
            <div id="hostInfo" class="connection-info" style="display: none;">
                <p class="instruction-text">ã‚¹ãƒãƒ›ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ä»¥ä¸‹ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                <div class="room-id-box">
                    <h2 id="displayRoomId"></h2>
                </div>
                <p id="connectionStatus" class="status-waiting">
                    <i class="fa-solid fa-spinner fa-spin"></i> ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å¾…æ©Ÿä¸­...
                </p>
            </div>

            <div id="controllerInfo" class="connection-info" style="display: none;">
                <div class="input-group">
                    <input type="text" id="inputRoomId" placeholder="éƒ¨å±‹ID (ä¾‹: 1234)" maxlength="4" pattern="\d*">
                </div>
                <button class="btn start-btn" onclick="joinGame()">æ¥ç¶šã™ã‚‹</button>
            </div>
        </div>

        <div class="header">
            <h1><i class="fa-solid fa-star"></i> ã‚¸ãƒ£ãƒ‹ãƒ¼ã‚ºã‚¯ã‚¤ã‚º</h1>
        </div>

        <div class="quiz-container glass-panel">
            <div class="quiz-setup" id="quizSetup">
                <div class="form-group">
                    <label>ã‚¯ã‚¤ã‚ºã®ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="quizTitle" value="ã‚¸ãƒ£ãƒ‹ãƒ¼ã‚ºã‚¯ã‚¤ã‚º">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>å•é¡Œæ•°</label>
                        <input type="number" id="questionCount" min="1" max="20" value="5">
                    </div>
                    <div class="form-group button-container">
                        <button class="btn primary-btn" onclick="generateQuiz()">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> ã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆ
                        </button>
                    </div>
                </div>
            </div>

            <div id="controllerScreen" class="controller-screen" style="display: none;">
                <h2><i class="fa-solid fa-gamepad"></i> ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼</h2>
                
                <div id="sensorControlArea">
                    <button id="enableSensorBtn" class="btn sensor-btn" onclick="requestSensorPermission()">
                        <i class="fa-solid fa-power-off"></i> æ“ä½œã‚’ONã«ã™ã‚‹
                    </button>
                    
                    <div id="sensorStatus" style="display: none;">
                        <div class="control-guide">
                            <div class="guide-item">
                                <div class="icon-box"><i class="fa-solid fa-up-down"></i></div>
                                <p>ã‚¹ãƒãƒ›ã‚’å‰å¾Œã«å‚¾ã‘ã¦<strong>é¸æŠ</strong></p>
                            </div>
                            <div class="guide-divider"></div>
                            <div class="guide-item">
                                <div class="icon-box rotate-icon"><i class="fa-solid fa-rotate-right"></i></div>
                                <p>å³ã«å‚¾ã‘ã¦<strong>æ±ºå®š</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="msg-area">
                    <p id="controllerMsg"></p>
                </div>
            </div>

            <div class="quiz-playing" id="quizPlaying">
                <div class="quiz-header">
                    <h2 id="quizTitleDisplay"></h2>
                    <div class="quiz-progress-badge" id="quizProgress"></div>
                </div>
                
                <div class="question-box">
                    <div id="timerContainer" class="timer-container">
                        <div class="timer-icon"><i class="fa-solid fa-stopwatch"></i></div>
                        <div class="timer-bar-bg">
                        <div id="timerBar" class="timer-bar"></div>
                    </div>
                 <div id="timerText" class="timer-text">15</div>
                </div>

<div class="question" id="currentQuestion"></div>
                    <div class="question" id="currentQuestion"></div>
                </div>

                <ul class="selections" id="selections"></ul>
                
                <div class="answer-feedback" id="answerFeedback"></div>
                
                <div class="action-buttons">
                    <button class="btn next-btn" id="nextBtn" onclick="nextQuestion()" style="display: none;">æ¬¡ã®å•é¡Œ <i class="fa-solid fa-arrow-right"></i></button>
                    <button class="btn finish-btn" id="finishBtn" onclick="showResults()" style="display: none;">çµæœã‚’è¦‹ã‚‹ <i class="fa-solid fa-flag-checkered"></i></button>
                </div>
            </div>

            <div class="quiz-results" id="quizResults">
                <div class="result-icon">ğŸ‘‘</div>
                <h2>ã‚¯ã‚¤ã‚ºçµæœ</h2>
                <div class="score" id="finalScore"></div>
                <button class="btn restart-btn" onclick="restartQuiz()">
                    <i class="fa-solid fa-rotate-left"></i> ã‚‚ã†ä¸€åº¦éŠã¶
                </button>
            </div>
        </div>

        <div class="footer-status">
            <span id="status" class="status-badge">Ready</span>
        </div>

        <div class="loading-overlay" id="loading">
            <div class="loading-content">
                <i class="fa-solid fa-circle-notch fa-spin"></i>
                <p>AIãŒã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentRoomId = null;
        let userRole = 'host';

        // --- å¤‰æ•°è¿½åŠ  ---
        let timerInterval = null;
        const TIME_LIMIT = 15; // åˆ¶é™æ™‚é–“ï¼ˆç§’ï¼‰
        
        let quizData = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedAnswer = null;
        let hasAnswered = false;
        
        let sensorHighlightIndex = 0;
        let isSensorActive = false;
        let lastScrollTime = 0;
        const SCROLL_DELAY = 400;

        function setMode(mode) {
            userRole = mode;
            // ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã‚’éš ã™ï¼ˆconnectionPanelè‡ªä½“ã¯æ®‹ã™ï¼‰
            document.querySelector('.mode-buttons').style.display = 'none';
            document.querySelector('#connectionPanel h3').style.display = 'none';
            
            if (mode === 'host') {
                currentRoomId = Math.floor(1000 + Math.random() * 9000).toString();
                document.getElementById('hostInfo').style.display = 'block';
                document.getElementById('displayRoomId').textContent = currentRoomId;
                
                socket.emit('join_room', currentRoomId);
                document.getElementById('quizSetup').style.display = 'block';
            } else {
                document.getElementById('controllerInfo').style.display = 'block';
                document.getElementById('quizSetup').style.display = 'none';
            }
        }

        function joinGame() {
            const inputId = document.getElementById('inputRoomId').value;
            if (inputId.length !== 4) return alert('4æ¡ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            
            currentRoomId = inputId;
            socket.emit('join_room', currentRoomId);
            
            document.getElementById('connectionPanel').style.display = 'none';
            document.getElementById('controllerScreen').style.display = 'block';
        }

        socket.on('controller_joined', () => {
            if (userRole === 'host') {
                const statusEl = document.getElementById('connectionStatus');
                statusEl.innerHTML = '<i class="fa-solid fa-check-circle"></i> æ¥ç¶šå®Œäº†ï¼æº–å‚™OK';
                statusEl.className = 'status-connected';
            }
        });

        
        socket.on('receive_command', (action) => {
            if (userRole !== 'host') return;

            // â˜…è¿½åŠ ãƒ­ã‚¸ãƒƒã‚¯ï¼šå›ç­”æ¸ˆã¿ã®å ´åˆã®å‡¦ç†
            if (hasAnswered) {
                // ã€Œæ±ºå®šï¼ˆå³ã«å‚¾ã‘ã‚‹ï¼‰ã€æ“ä½œãŒæ¥ãŸã‚‰ã€æ¬¡ã®å•é¡Œã¸
                if (action === 'select') {
                    if (currentQuestionIndex < quizData.length - 1) {
                        nextQuestion(); // æ¬¡ã®å•é¡Œã¸ï¼ˆã‚¿ã‚¤ãƒãƒ¼ã‚‚å¾©æ´»ã—ã¾ã™ï¼‰
                    } else {
                        showResults();  // æœ€å¾Œã®å•é¡Œãªã‚‰çµæœç”»é¢ã¸
                    }
                }
                return; // ã“ã“ã§å‡¦ç†ã‚’çµ‚ã‚ã‚‰ã›ã‚‹ï¼ˆå›ç­”é¸æŠã¸è¡Œã‹ã›ãªã„ï¼‰
            }

            // å›ç­”å‰ã®é€šå¸¸ã®æ“ä½œ
            if (action === 'up') moveHighlight(-1);
            if (action === 'down') moveHighlight(1);
            if (action === 'select') selectAnswer(sensorHighlightIndex);
        });

        
        async function requestSensorPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') startSensor();
                    else alert('è¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
                } catch (e) { alert('HTTPSãŒå¿…è¦ã§ã™'); }
            } else {
                startSensor();
            }
        }

        function startSensor() {
            window.addEventListener('deviceorientation', handleOrientation);
            isSensorActive = true;
            document.getElementById('enableSensorBtn').style.display = 'none';
            document.getElementById('sensorStatus').style.display = 'block';
        }

        function handleOrientation(event) {
            if (!isSensorActive || !currentRoomId) return;

            const now = Date.now();
            const beta = event.beta; 
            const gamma = event.gamma;

            if (now - lastScrollTime > SCROLL_DELAY) {
                if (beta < 30) { 
                    socket.emit('send_command', { roomId: currentRoomId, action: 'up' });
                    flashControllerMsg('â¬†ï¸ ä¸Šã¸');
                    lastScrollTime = now;
                } else if (beta > 70) { 
                    socket.emit('send_command', { roomId: currentRoomId, action: 'down' });
                    flashControllerMsg('â¬‡ï¸ ä¸‹ã¸');
                    lastScrollTime = now;
                }
            }

            if (gamma > 30) {
                 if (now - lastScrollTime > 1000) {
                    socket.emit('send_command', { roomId: currentRoomId, action: 'select' });
                    flashControllerMsg('ğŸ†— æ±ºå®šï¼');
                    if (navigator.vibrate) navigator.vibrate(200);
                    lastScrollTime = now;
                 }
            }
        }

        function flashControllerMsg(text) {
            const msg = document.getElementById('controllerMsg');
            msg.textContent = text;
            setTimeout(() => msg.textContent = '', 500);
        }

        function moveHighlight(direction) {
            if (document.getElementById('quizPlaying').style.display === 'none') return;
            if (hasAnswered) return;

            const maxIndex = quizData[currentQuestionIndex].selections.length - 1;
            let newIndex = sensorHighlightIndex + direction;

            if (newIndex < 0) newIndex = 0;
            if (newIndex > maxIndex) newIndex = maxIndex;

            if (newIndex !== sensorHighlightIndex) {
                sensorHighlightIndex = newIndex;
                highlightSelection(sensorHighlightIndex);
            }
        }

        function highlightSelection(index) {
            const items = document.querySelectorAll('.selection-item');
            items.forEach((item, i) => {
                if (i === index) item.classList.add('sensor-highlight');
                else item.classList.remove('sensor-highlight');
            });
        }

        async function generateQuiz() {
            if(userRole !== 'host') return;

            const title = document.getElementById('quizTitle').value.trim();
            const count = parseInt(document.getElementById('questionCount').value);
            
            document.getElementById('loading').classList.add('show');

            try {
                const response = await fetch('/api/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, count })
                });

                const data = await response.json();
                quizData = data.data;
                currentQuestionIndex = 0;
                score = 0;
                document.getElementById('quizTitleDisplay').textContent = data.title;
                startQuiz();
            } catch (error) {
                alert('ç”Ÿæˆå¤±æ•—: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('show');
            }
        }

        function startQuiz() {
            document.getElementById('quizSetup').style.display = 'none';
            document.getElementById('quizPlaying').style.display = 'block';
            document.getElementById('quizResults').style.display = 'none';
            document.getElementById('connectionPanel').style.display = 'none';
            showQuestion();
        }





        // --- ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸæ–°ã—ã„é–¢æ•°ãŸã¡ ---

        function startTimer() {
            let timeLeft = TIME_LIMIT;
            const timerBar = document.getElementById('timerBar');
            const timerText = document.getElementById('timerText');
            
            // è¡¨ç¤ºã®ãƒªã‚»ãƒƒãƒˆ
            timerText.textContent = timeLeft;
            timerBar.style.width = '100%';
            timerBar.style.backgroundColor = '#48bb78'; // ç·‘è‰²

            // 1ç§’ã”ã¨ã«å®Ÿè¡Œ
            timerInterval = setInterval(() => {
                timeLeft--;
                timerText.textContent = timeLeft;
                
                // ãƒãƒ¼ã®é•·ã•ã‚’æ›´æ–°
                const percentage = (timeLeft / TIME_LIMIT) * 100;
                timerBar.style.width = `${percentage}%`;

                // è‰²ã‚’å¤‰ãˆã‚‹æ¼”å‡ºï¼ˆ5ç§’ä»¥ä¸‹ã§èµ¤ãï¼‰
                if (timeLeft <= 5) {
                    timerBar.style.backgroundColor = '#e53e3e';
                } else if (timeLeft <= 10) {
                    timerBar.style.backgroundColor = '#ecc94b';
                }

                // æ™‚é–“åˆ‡ã‚Œåˆ¤å®š
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timeUp(); // æ™‚é–“åˆ‡ã‚Œå‡¦ç†ã¸
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function timeUp() {
            // æ™‚é–“åˆ‡ã‚Œã¨ã—ã¦å‡¦ç†ï¼ˆ-1 ã¯æ™‚é–“åˆ‡ã‚Œã®åˆå›³ï¼‰
            selectAnswer(-1);
        }

        // --- æ—¢å­˜ã®é–¢æ•°ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ ---

        function showQuestion() {
            if (currentQuestionIndex >= quizData.length) {
                showResults();
                return;
            }
            // å‰ã®ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°æ­¢ã‚ã‚‹
            stopTimer();

            const question = quizData[currentQuestionIndex];
            hasAnswered = false;
            selectedAnswer = null;
            sensorHighlightIndex = 0;

            document.getElementById('quizProgress').textContent = `Q.${currentQuestionIndex + 1} / ${quizData.length}`;
            document.getElementById('currentQuestion').textContent = question.question;
            
            const selectionsEl = document.getElementById('selections');
            selectionsEl.innerHTML = '';
            
            question.selections.forEach((selection, index) => {
                const li = document.createElement('li');
                li.className = 'selection-item';
                li.textContent = selection;
                li.onclick = () => selectAnswer(index);
                selectionsEl.appendChild(li);
            });

            highlightSelection(0);

            document.getElementById('answerFeedback').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('finishBtn').style.display = 'none';

            // â˜…ã“ã“ã§ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ï¼
            startTimer();
        }

        function selectAnswer(index) {
            if (hasAnswered) return;
            
            // â˜…å›ç­”ã—ãŸã‚‰ã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹
            stopTimer();
            
            selectedAnswer = index;
            hasAnswered = true;

            const question = quizData[currentQuestionIndex];
            // indexãŒ -1 ãªã‚‰æ™‚é–“åˆ‡ã‚Œã€ãã‚Œä»¥å¤–ãªã‚‰æ­£èª¤åˆ¤å®š
            const isCorrect = (index !== -1) && (selectedAnswer === question.answer);
            
            if (isCorrect) score++;

            const items = document.querySelectorAll('.selection-item');
            items.forEach((item, i) => {
                item.onclick = null;
                item.classList.remove('sensor-highlight');
                if (i === question.answer) item.classList.add('correct');
                else if (i === selectedAnswer && !isCorrect && index !== -1) item.classList.add('incorrect');
                else item.style.opacity = '0.5';
            });

            const feedback = document.getElementById('answerFeedback');
            feedback.style.display = 'block';
            
            if (index === -1) {
                // æ™‚é–“åˆ‡ã‚Œã®å ´åˆã®è¡¨ç¤º
                feedback.className = 'answer-feedback incorrect';
                feedback.innerHTML = `<i class="fa-regular fa-clock"></i> æ™‚é–“åˆ‡ã‚Œï¼<br><span style="font-size:0.8em">æ­£è§£ã¯ã€Œ${question.selections[question.answer]}ã€</span>`;
            } else {
                // é€šå¸¸ã®æ­£èª¤è¡¨ç¤º
                feedback.className = isCorrect ? 'answer-feedback correct' : 'answer-feedback incorrect';
                feedback.innerHTML = isCorrect ? 
                    '<i class="fa-regular fa-circle-check"></i> æ­£è§£ï¼' : 
                    `<i class="fa-regular fa-circle-xmark"></i> ä¸æ­£è§£...<br><span style="font-size:0.8em">æ­£è§£ã¯ã€Œ${question.selections[question.answer]}ã€</span>`;
            }

            if (currentQuestionIndex < quizData.length - 1) {
                document.getElementById('nextBtn').style.display = 'inline-block';
            } else {
                document.getElementById('finishBtn').style.display = 'inline-block';
            }
        }






        function nextQuestion() {
            currentQuestionIndex++;
            showQuestion();
        }

        function showResults() {
            document.getElementById('quizPlaying').style.display = 'none';
            document.getElementById('quizResults').style.display = 'block';
            const percentage = Math.round((score / quizData.length) * 100);
            document.getElementById('finalScore').innerHTML = `
                <span style="font-size: 1.5em; display:block; margin-bottom:10px;">${score}å• æ­£è§£ï¼</span>
                <span style="font-size: 0.8em; opacity: 0.8;">(å…¨${quizData.length}å•ä¸­)</span>
            `;
        }

        function restartQuiz() {
            location.reload(); // ãƒªã‚»ãƒƒãƒˆã‚’ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰
        }

        document.addEventListener('DOMContentLoaded', updateStatus);
        function updateStatus() {
            document.getElementById('status').textContent = 'System Ready';
        }
    </script>
</body>
</html>